<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Periscope</title>
  <style>
    :root {
      --bg: #0f0f12;
      --surface: #18181c;
      --border: #2a2a30;
      --text: #e4e4e7;
      --muted: #a1a1aa;
      --accent: #7c3aed;
      --accent-hover: #8b5cf6;
      --success: #22c55e;
      --warning: #eab308;
      --radius: 8px;
    }
    * { box-sizing: border-box; }
    body {
      font-family: "DM Sans", system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      margin: 0;
      min-height: 100vh;
      line-height: 1.5;
    }
    .container {
      max-width: 720px;
      margin: 0 auto;
      padding: 2rem 1rem;
    }
    h1 {
      font-size: 1.5rem;
      font-weight: 600;
      margin: 0 0 0.25rem 0;
      letter-spacing: -0.02em;
    }
    .subtitle {
      color: var(--muted);
      font-size: 0.875rem;
      margin-bottom: 2rem;
    }
    .form-row {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }
    .form-row input[type="text"] {
      flex: 1;
      padding: 0.75rem 1rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      font-size: 1rem;
    }
    .form-row input[type="text"]::placeholder { color: var(--muted); }
    .form-row input[type="text"]:focus {
      outline: none;
      border-color: var(--accent);
    }
    .form-row input[type="number"] {
      width: 4.5rem;
      padding: 0.75rem;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      font-size: 0.875rem;
    }
    button {
      padding: 0.75rem 1.25rem;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: var(--radius);
      font-size: 0.9375rem;
      font-weight: 500;
      cursor: pointer;
    }
    button:hover { background: var(--accent-hover); }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .results {
      margin-top: 2rem;
    }
    .results.hidden { display: none; }
    .meta {
      display: flex;
      flex-wrap: wrap;
      gap: 1rem;
      font-size: 0.8125rem;
      color: var(--muted);
      margin-bottom: 1rem;
    }
    .meta span { display: inline-flex; align-items: center; gap: 0.25rem; }
    .answer-block {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1.25rem;
      margin-bottom: 1.5rem;
      white-space: pre-wrap;
    }
    .answer-block.abstained {
      border-color: var(--warning);
      color: var(--muted);
    }
    .sources-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--muted);
      margin-bottom: 0.75rem;
    }
    .source {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 1rem;
      margin-bottom: 0.75rem;
      font-size: 0.9375rem;
    }
    .source-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    .source-score {
      font-size: 0.75rem;
      color: var(--accent);
      font-weight: 500;
    }
    .source-text {
      color: var(--text);
      white-space: pre-wrap;
      word-break: break-word;
    }
    .error {
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid rgba(239, 68, 68, 0.4);
      border-radius: var(--radius);
      padding: 1rem;
      color: #fca5a5;
      margin-top: 1rem;
    }
    .loading {
      color: var(--muted);
      font-size: 0.9375rem;
      margin-top: 1rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Periscope</h1>
    <p class="subtitle">Ask a question about papers. Results are generated by the API.</p>

    <form id="query-form">
      <div class="form-row">
        <input type="text" id="query" name="query" placeholder="e.g. What methods are used?" required autocomplete="off" />
        <input type="number" id="top_k" name="top_k" min="1" max="50" placeholder="k" title="Max sources (optional)" />
        <button type="submit" id="submit-btn">Query</button>
      </div>
    </form>

    <div id="loading" class="loading hidden">Sending query…</div>
    <div id="error" class="error hidden"></div>
    <div id="results" class="results hidden"></div>
  </div>

  <script>
    const form = document.getElementById("query-form");
    const queryInput = document.getElementById("query");
    const topKInput = document.getElementById("top_k");
    const submitBtn = document.getElementById("submit-btn");
    const loadingEl = document.getElementById("loading");
    const errorEl = document.getElementById("error");
    const resultsEl = document.getElementById("results");

    const API_BASE = "";

    function showLoading(show) {
      loadingEl.classList.toggle("hidden", !show);
      submitBtn.disabled = show;
    }
    function showError(msg) {
      errorEl.textContent = msg || "";
      errorEl.classList.toggle("hidden", !msg);
    }
    function showResults(html) {
      resultsEl.innerHTML = html || "";
      resultsEl.classList.toggle("hidden", !html);
    }

    function escapeHtml(s) {
      const div = document.createElement("div");
      div.textContent = s;
      return div.innerHTML;
    }

    function formatSource(node) {
      const score = typeof node.score === "number" ? node.score.toFixed(4) : String(node.score ?? "—");
      const meta = node.metadata || {};
      const filePath = meta.file_path ? escapeHtml(String(meta.file_path)) : "";
      const pageNum = meta.page_number != null ? escapeHtml(String(meta.page_number)) : "";
      const label = filePath
        ? (pageNum ? `Page ${pageNum} · ${filePath}` : filePath)
        : (node.text ? escapeHtml(node.text.slice(0, 200)) + (node.text.length > 200 ? "…" : "") : "—");
      return (
        "<div class=\"source\">" +
        "<div class=\"source-header\"><span class=\"source-score\">score " + escapeHtml(score) + "</span></div>" +
        "<div class=\"source-text\">" + label + "</div>" +
        "</div>"
      );
    }

    function renderResponse(data) {
      const meta = data.metadata || {};
      const metaParts = [];
      if (typeof meta.retrieval_time_seconds === "number") {
        metaParts.push(`<span>Retrieval: ${meta.retrieval_time_seconds}s</span>`);
      }
      if (typeof meta.generation_time_seconds === "number") {
        metaParts.push(`<span>Generation: ${meta.generation_time_seconds}s</span>`);
      }
      if (typeof meta.num_sources === "number") {
        metaParts.push(`<span>${meta.num_sources} source(s)</span>`);
      }
      if (meta.abstained_reason) {
        metaParts.push(`<span>Abstained: ${escapeHtml(meta.abstained_reason)}</span>`);
      }

      let answerHtml = "";
      if (data.abstained) {
        answerHtml = `<div class="answer-block abstained">No answer (guardrails abstained).</div>`;
      } else {
        const answer = (data.answer != null && data.answer !== "") ? escapeHtml(data.answer) : "No answer generated.";
        answerHtml = `<div class="answer-block">${answer}</div>`;
      }

      const sources = data.sources || [];
      const sourcesHtml = sources.length
        ? `<div class="sources-title">Sources</div>${sources.map(formatSource).join("")}`
        : "";

      const metaHtml = metaParts.length
        ? `<div class="meta">${metaParts.join("")}</div>`
        : "";

      showResults(metaHtml + answerHtml + sourcesHtml);
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const query = (queryInput.value || "").trim();
      if (!query) return;

      showError("");
      showResults("");
      showLoading(true);

      const body = { query };
      const topK = topKInput.value ? parseInt(topKInput.value, 10) : null;
      if (topK != null && !isNaN(topK) && topK >= 1 && topK <= 50) {
        body.top_k = topK;
      }

      try {
        const res = await fetch(`${API_BASE}/query`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });
        const data = await res.json();
        if (!res.ok) {
          showError(data.detail || res.statusText || "Request failed");
          return;
        }
        renderResponse(data);
      } catch (err) {
        showError(err.message || "Network error. Is the API running on this host?");
      } finally {
        showLoading(false);
      }
    });
  </script>
</body>
</html>
